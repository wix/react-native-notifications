From 13303d2c4e3d6ed34eb6646b51e9432f1153c87a Mon Sep 17 00:00:00 2001
From: Pereladov <pereladov_ad@ekb.sima-land.ru>
Date: Tue, 1 Sep 2020 09:26:41 +0500
Subject: [PATCH] implement image in payload notifications

---
 .../core/notification/PushNotification.java   | 21 +++++++++++++++++
 .../notification/PushNotificationProps.java   | 23 +++++++++++++++++--
 package.json                                  |  2 +-
 3 files changed, 43 insertions(+), 3 deletions(-)

diff --git a/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotification.java b/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotification.java
index 507dd42..f1652a2 100644
--- a/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotification.java
+++ b/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotification.java
@@ -6,6 +6,8 @@ import android.app.NotificationManager;
 import android.app.PendingIntent;
 import android.content.Context;
 import android.content.Intent;
+import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
 import android.os.Build;
 import android.os.Bundle;
 
@@ -19,6 +21,10 @@ import com.wix.reactnativenotifications.core.JsIOHelper;
 import com.wix.reactnativenotifications.core.NotificationIntentAdapter;
 import com.wix.reactnativenotifications.core.ProxyService;
 
+import java.io.IOException;
+import java.io.InputStream;
+import java.net.URL;
+
 import static com.wix.reactnativenotifications.Defs.NOTIFICATION_OPENED_EVENT_NAME;
 import static com.wix.reactnativenotifications.Defs.NOTIFICATION_RECEIVED_EVENT_NAME;
 
@@ -144,6 +150,14 @@ public class PushNotification implements IPushNotification {
 
         String CHANNEL_ID = "channel_01";
         String CHANNEL_NAME = "Channel Name";
+        String url = mNotificationProps.getImageUrl();
+        Bitmap bmp = null;
+        try {
+            InputStream in = new URL(url).openStream();
+            bmp = BitmapFactory.decodeStream(in);
+        } catch (IOException e) {
+            e.printStackTrace();
+        }
 
         final Notification.Builder notification = new Notification.Builder(mContext)
                 .setContentTitle(mNotificationProps.getTitle())
@@ -152,6 +166,13 @@ public class PushNotification implements IPushNotification {
                 .setDefaults(Notification.DEFAULT_ALL)
                 .setAutoCancel(true);
 
+        if (url != null) {
+            notification.setStyle(
+                    new Notification.BigPictureStyle()
+                            .bigPicture(bmp))
+                    .setLargeIcon(bmp);
+        }
+
         setUpIcon(notification);
 
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
diff --git a/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotificationProps.java b/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotificationProps.java
index a8545c3..2378c54 100644
--- a/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotificationProps.java
+++ b/lib/android/app/src/main/java/com/wix/reactnativenotifications/core/notification/PushNotificationProps.java
@@ -1,12 +1,16 @@
 package com.wix.reactnativenotifications.core.notification;
 
 import android.os.Bundle;
+import java.util.HashMap;
+import java.util.Iterator;
+import java.util.Map;
+import java.util.Set;
 
 public class PushNotificationProps {
 
     protected Bundle mBundle;
 
-    public PushNotificationProps(Bundle bundle) {
+     public PushNotificationProps(Bundle bundle) {
         mBundle = bundle;
     }
 
@@ -14,6 +18,21 @@ public class PushNotificationProps {
         return getBundleStringFirstNotNull("gcm.notification.title", "title");
     }
 
+    public String getImageUrl() {
+        return bundleToMap((Bundle) mBundle.get("data")).get("image");
+    }
+
+    public static Map<String, String> bundleToMap(Bundle extras) {
+        Map<String, String> map = new HashMap<>();
+        Set<String> ks = extras.keySet();
+        Iterator<String> iterator = ks.iterator();
+        while (iterator.hasNext()) {
+            String key = iterator.next();
+            map.put(key, extras.getString(key));
+        }
+        return map;
+    }
+
     public String getBody() {
         return getBundleStringFirstNotNull("gcm.notification.body", "body");
     }
@@ -39,7 +58,7 @@ public class PushNotificationProps {
         return new PushNotificationProps((Bundle) mBundle.clone());
     }
 
-    private String getBundleStringFirstNotNull(String key1, String key2) {
+    private String  getBundleStringFirstNotNull(String key1, String key2) {
         String result = mBundle.getString(key1);
         return result == null ? mBundle.getString(key2) : result;
     }
diff --git a/package.json b/package.json
index 96a88b2..cf0c084 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "react-native-notifications",
-  "version": "3.3.2",
+  "version": "3.3.3",
   "description": "Advanced Push Notifications (Silent, interactive notifications) for iOS & Android",
   "author": "Lidan Hifi <lidan.hifi@gmail.com>",
   "license": "MIT",
-- 
2.24.3 (Apple Git-128)

